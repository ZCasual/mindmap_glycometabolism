<!DOCTYPE html>
<html lang="zh">
<head> 
    <meta charset="UTF-8">
    <title>代谢通路知识图谱</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f5f5;
        }
        #graph {
            width: 100%;
            height: 600px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .node {
            cursor: pointer;
        }
        .node text {
            font-size: 14px;
        }
        .link {
            stroke: #999;
            stroke-width: 2px;
        }
        .arrow {
            fill: #999;
        }
    </style>
</head>
<body>
    <div id="graph"></div>
    <script>
        const data = {
            nodes: [
                { id: "EMP", label: "EMP", level: 1 },
                { id: "TCA", label: "TCA", level: 1 },
                { id: "PPP", label: "PPP", level: 1 },
                { id: "Glucose", label: "Glucose", level: 2 },
                { id: "GS", label: "GS", level: 1 },
                { id: "GNG", label: "GNG", level: 1 }
            ],
            links: [
                { source: "Glucose", target: "EMP", bidirectional: false },
                { source: "EMP", target: "TCA", bidirectional: false },
                { source: "EMP", target: "PPP", bidirectional: false },
                { source: "GS", target: "Glucose", bidirectional: false },
                { source: "GNG", target: "EMP", bidirectional: false },
                { source: "EMP", target: "GNG", bidirectional: true }
            ]
        };

        const width = document.getElementById('graph').clientWidth;
        const height = document.getElementById('graph').clientHeight;

        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // 添加一个容器组来实现平移和缩放
        const g = svg.append("g");

        // 添加缩放行为
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // 添加箭头标记到新的容器组
        g.append("defs").selectAll("marker")
            .data(["arrow", "double-arrow"])
            .enter().append("marker")
            .attr("id", d => d)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 15)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", d => d === "arrow" 
                ? "M0,-5L10,0L0,5"
                : "M0,-5L10,0L0,5 M10,0L20,0")
            .attr("class", "arrow");

        // 将 link 和 node 添加到容器组而不是直接添加到 svg
        const link = g.append("g")
            .selectAll("line")
            .data(data.links)
            .join("line")
            .attr("class", "link")
            .attr("marker-end", d => d.bidirectional ? "url(#double-arrow)" : "url(#arrow)");

        // 添加文本标签到连线上
        const linkLabels = g.append("g")
            .selectAll("text")
            .data(data.links)
            .join("text")
            .attr("class", "link-label")
            .attr("text-anchor", "middle")
            .attr("dy", -5)
            .text(d => d.label || "");

        // 在创建节点之前，添加分组
        const groups = g.append("g")
            .selectAll(".group")
            .data(["TCA"])
            .join("g")
            .attr("class", "group");

        // 修改node的选择方式，将TCA组的节点放在一起
        const node = g.append("g")
            .selectAll("g")
            .data(data.nodes)
            .join("g")
            .attr("class", d => `node ${d.group || ""}`)
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node.append("circle")
            .attr("r", d => d.level === 1 ? 25 : 20)
            .style("fill", d => d.level === 1 ? "#4CAF50" : "#90CAF9")
            .style("stroke", "#fff")
            .style("stroke-width", "2px");

        node.append("text")
            .text(d => d.label)
            .attr("text-anchor", "middle")
            .attr("dy", ".35em")
            .style("fill", "#333");

        const simulation = d3.forceSimulation(data.nodes)
            .force("link", d3.forceLink(data.links).id(d => d.id).distance(180))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2));

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            linkLabels
                .attr("x", d => (d.source.x + d.target.x) / 2)
                .attr("y", d => (d.source.y + d.target.y) / 2);

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // 添加窗口大小改变的响应
        window.addEventListener('resize', () => {
            const newWidth = document.getElementById('graph').clientWidth;
            const newHeight = document.getElementById('graph').clientHeight;
            
            svg.attr("width", newWidth)
               .attr("height", newHeight);
            
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2))
                     .restart();
        });

        // 修改拖拽函数以配合缩放
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
    </script>
</body>
</html> 