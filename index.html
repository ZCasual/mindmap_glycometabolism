<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代谢路径图</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background-color: #1e1e1e;
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #graph {
            width: 100%;
            height: 600px;
            background-color: #1e1e1e;
            border-radius: 8px;
        }

        .node circle {
            stroke: #3d3d3d;
            stroke-width: 2px;
        }

        .node.primary circle {
            fill: #2d2d2d;
        }

        .node.secondary circle {
            fill: #252525;
        }

        .node text {
            fill: #d4d4d4;
            text-anchor: middle;
            font-size: 14px;
        }

        .link {
            stroke: #4a4a4a;
            stroke-width: 2px;
        }

        .arrow {
            fill: #4a4a4a;
        }
    </style>
               PPP
                ↑
Glucose → EMP → TCA
 ↑        ↑↓
 GS      GNG

</head>
<body>
    <div id="graph"></div>
    <script>
        const data = {
            nodes: [
                { id: "Glucose", label: "葡萄糖", group: "Glucose" },
                { id: "EMP", label: "EMP", group: "EMP" },
                { id: "PPP", label: "PPP", group: "PPP" },
                { id: "TCA", label: "TCA", group: "TCA" },
                { id: "GS", label: "GS", group: "GS" },
                { id: "GNG", label: "GNG", group: "GNG" }
            ],
            links: [
                { source: "Glucose", target: "EMP", double: false },
                { source: "EMP", target: "TCA", double: false },
                { source: "TCA", target: "PPP", double: false },
                { source: "EMP", target: "GNG", double: true },
                { source: "GS", target: "Glucose", double: false }
            ]
        };

        const width = document.getElementById('graph').clientWidth;
        const height = document.getElementById('graph').clientHeight;

        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        // 添加缩放功能
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // 添加颜色比例尺
        const color = d3.scaleOrdinal()
            .domain(["Glucose", "EMP", "TCA", "PPP", "GS", "GNG"])
            .range(["#FF1493", "#4CAF50", "#FF5722", "#2196F3", "#9C27B0", "#FFC107"]);

        // 定义箭头
        const defs = g.append("defs");
        
        // 定义箭头标记
        defs.append("marker")
            .attr("id", "arrow")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 10)  // 保持您的refX值
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("class", "arrow");

        // 创建连接线
        const link = g.append("g")
            .selectAll("line")
            .data(data.links)
            .join("line")
            .attr("class", "link")
            .attr("marker-end", "url(#arrow)")
            .style("stroke", "#4a4a4a")
            .style("stroke-width", "2px");

        // 为双向连接添加反向线段
        const doubleLink = g.append("g")
            .selectAll("line")
            .data(data.links.filter(d => d.double))
            .join("line")
            .attr("class", "link")
            .attr("marker-end", "url(#arrow)")
            .style("stroke", "#4a4a4a")
            .style("stroke-width", "2px");

        // 创建节点
        const node = g.append("g")
            .selectAll(".node")
            .data(data.nodes)
            .join("g")
            .attr("class", d => `node ${d.type}`)
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node.append("circle")
            .attr("r", 30)
            .style("fill", d => color(d.group))
            .style("stroke", "#3d3d3d")
            .style("stroke-width", "2px");

        node.append("text")
            .text(d => d.label)
            .attr("dy", ".35em")
            .style("fill", "#FFFFFF");

        // 力导向图配置
        const simulation = d3.forceSimulation(data.nodes)
            .force("link", d3.forceLink(data.links)
                .id(d => d.id)
                .distance(200))
            .force("charge", d3.forceManyBody().strength(-1000))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(50));

        // 更新位置
        simulation.on("tick", () => {
            link.attr("x1", d => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                return d.source.x + (dx * 25) / dr;
            })
            .attr("y1", d => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                return d.source.y + (dy * 25) / dr;
            })
            .attr("x2", d => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                return d.target.x - (dx * 27) / dr;
            })
            .attr("y2", d => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                return d.target.y - (dy * 27) / dr;
            });

            // 更新双向连接的反向线段
            doubleLink.attr("x1", d => {
                const dx = d.source.x - d.target.x;
                const dy = d.source.y - d.target.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                return d.target.x + (dx * 25) / dr;
            })
            .attr("y1", d => {
                const dx = d.source.x - d.target.x;
                const dy = d.source.y - d.target.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                return d.target.y + (dy * 25) / dr;
            })
            .attr("x2", d => {
                const dx = d.source.x - d.target.x;
                const dy = d.source.y - d.target.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                return d.source.x - (dx * 27) / dr;
            })
            .attr("y2", d => {
                const dx = d.source.x - d.target.x;
                const dy = d.source.y - d.target.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                return d.source.y - (dy * 27) / dr;
            });

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // 拖拽函数
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        // 响应窗口大小变化
        window.addEventListener('resize', () => {
            const newWidth = document.getElementById('graph').clientWidth;
            const newHeight = document.getElementById('graph').clientHeight;
            
            svg.attr("width", newWidth)
               .attr("height", newHeight);
            
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2))
                     .restart();
        });
    </script>
</body>
</html>
